function Console(element,options){this.options=jQuery.extend({},Console.CONSOLE_DEFAULTS,options||{}),this.element=element,this.ctx=this.element.getContext("2d"),this.ctx||alert("2d context not found")}jQuery.fn.console=function(cfg,value){return"string"!=typeof cfg?(cfg=cfg||{},this.each(function(idx,element){"canvas"==element.nodeName.toLowerCase()&&(element.console=new Console(element,cfg),element.console.init_console())})):this.each(function(idx,element){"set_text"==cfg?element.console._set_text(value):"write"==cfg?element.console._write(value):"writeln"==cfg?element.console._writeln(value):"register_command"==cfg?element.console.register_command(value):"lock_input"==cfg&&element.console.lock_input()}),this},Console.prototype.init_console=function(){this.width=jQuery(this.element).width(),this.height=jQuery(this.element).height(),this.ctx.font="normal "+this.options.fontsize+"px "+this.options.fontname,this.fontwidth=this.ctx.measureText("M").width+1,this.fontheight=this.options.fontsize,this.cols=Math.floor(this.width/this.fontwidth)-1,this.rows=Math.floor(this.height/this.fontheight)-1,this.init_buffer(),this.blink_cursor();var me=this;jQuery(this.element).bind("keydown",function(event){return me._keydown(event)}),jQuery(this.element).bind("keypress",function(event){return me._keypress(event)}),jQuery(this.element).bind("mousewheel",function(event){return me._mouse_wheel(event)}),jQuery(this.element).bind("DOMMouseScroll",function(event){return me._mouse_wheel(event)}),setInterval(function(){me.draw_buffer()},33),this.commands=new Array,this.command_history=new Array,this.current_command=0,this.addr_format=new Array,this.register_command({command:this.options.helpcommand,description:this.options.helpcommanddesc,callback:function(){for(var i=0;i<this.commands.length;i++){var command=this.commands[i];i>0&&this.writeln(""),this.write(command.command),this.write(this.options.helpspaces),this.write(command.description)}}}),this.register_command({command:this.options.clearcommand,description:this.options.clearcommanddesc,callback:function(){return this.command_history=new Array,this.current_command=0,this.addr_format=new Array,this.init_buffer(),!0}})},Console.prototype._mouse_wheel=function(event){event.detail||(event.wheelDelta>0?event.detail=-1:event.detail=1);var delta=event.detail*Math.ceil(this.rows/3);this.memmap_addr+=delta*this.cols,this.memmap_addr<0?this.memmap_addr=0:this.memmap_addr+this.rows*this.cols>=this.buffer.length&&(this.memmap_addr=this.buffer.length-this.rows*this.cols)},Console.prototype.clear_cursor=function(){this.cursor&&(this.buffer[this.memmap_addr+this.cursor_row*this.cols+this.cursor_col]=" ",this.cursor_col=0,this.cursor_row=0,this.cursor=!1)},Console.prototype.blink_cursor=function(){var me=this;setInterval(function(){me.enable_external_input?"_"==me.buffer[me.memmap_addr+me.current_row*me.cols+me.current_col]?(me.buffer[me.memmap_addr+me.current_row*me.cols+me.current_col]=" ",me.cursor_col=-1,me.cursor_row=-1,me.cursor=!1):(me.buffer[me.memmap_addr+me.current_row*me.cols+me.current_col]="_",me.cursor_col=me.current_col,me.cursor_row=me.current_row,me.cursor=!0):me.input&&me.memmap_addr==me.original_memmap_addr&&("_"==me.buffer[me.memmap_addr+me.current_row*me.cols+me.current_col]?(me.buffer[me.memmap_addr+me.current_row*me.cols+me.current_col]=" ",me.cursor_col=-1,me.cursor_row=-1,me.cursor=!1):(me.buffer[me.memmap_addr+me.current_row*me.cols+me.current_col]="_",me.cursor_col=me.current_col,me.cursor_row=me.current_row,me.cursor=!0))},500)},Console.prototype.init_buffer=function(){this.current_row=0,this.current_col=0,this.memmap_addr=0,this.original_memmap_addr=this.memmap_addr,this.buffer=new Array;for(var i=0;i<this.rows*this.cols;i++)this.buffer[i]=" ";this.options.oninit&&this.options.oninit.call(this),this.lock_input()},Console.prototype.register_command=function(param){param.command&&param.callback&&param.description&&(this.commands.push(param),this.commands.sort(this._sort_commands))},Console.prototype._sort_commands=function(a,b){return a.command==b.command?0:a.command>b.command?1:-1},Console.prototype._keydown=function(event){if(this.input){if(this.memmap_addr=this.original_memmap_addr,this.clear_cursor(),13==event.which)return this.input=!1,this.parse_command_line(),event.preventDefault(),event.stopPropagation(),!1;if(8==event.which)return this.current_col--,this.current_col<this.command_start_col&&this.command_start_row==this.current_row?this.current_col=this.command_start_col:this.current_col<0&&(this.current_col=this.cols-1,this.current_row--),this.buffer[this.memmap_addr+this.current_row*this.cols+this.current_col]=" ",this.command.length>0&&this.command.pop(),event.preventDefault(),event.stopPropagation(),!1;if(38==event.which)return this.current_command>0&&this.set_command(this.command_history[--this.current_command]),event.preventDefault(),event.stopPropagation(),!1;if(40==event.which)return this.current_command<this.command_history.length-1?this.set_command(this.command_history[++this.current_command]):(this.set_command([""]),++this.current_command),event.preventDefault(),event.stopPropagation(),!1}else if(this.enable_external_input){if(this.clear_cursor(),13==event.which)return!this.grab_extended||event.ctrlKey?(this.command.length>0||!this.grab_required)&&(this.enable_external_input=!1,this.external_input_callback.call(this,this.command.join(""))):this.grab_extended&&(this.last_col.push(this.current_col),this.command.push("\n"),this.writeln("")),event.preventDefault(),event.stopPropagation(),!1;if(8==event.which)return this.current_col--,this.current_col<this.command_start_col&&this.command_start_row==this.current_row?this.current_col=this.command_start_col:this.current_col<0&&(this.current_col=this.last_col.pop(),this.current_row--),this.buffer[this.memmap_addr+this.current_row*this.cols+this.current_col]=" ",this.command.length>0&&this.command.pop(),event.preventDefault(),event.stopPropagation(),!1;if(67==event.which&&event.ctrlKey)return this.write("^C"),this.enable_external_input=!1,this.external_input_callback.call(this,"^C"),event.preventDefault(),event.stopPropagation(),!1}},Console.prototype.set_command=function(aCommand){this.command=aCommand;for(var i=this.command_start_row;i<=this.current_row;i++)for(var j=this.command_start_col;j<this.current_col;j++)this.buffer[this.memmap_addr+i*this.cols+j]=" ";this.current_row=this.command_start_row,this.current_col=this.command_start_col,this.write(this.command.join(""))},Console.prototype._keypress=function(event){if((this.input||this.enable_external_input)&&event.charCode>0){this.memmap_addr=this.original_memmap_addr,this.clear_cursor();var car=String.fromCharCode(event.charCode);this.command.push(car),this.grab_password?this.write("*"):this.write(car)}},Console.prototype._find_command=function(command){for(var i=0;i<this.commands.length;i++)if(this.commands[i].command==command)return this.commands[i];return null},Console.prototype.parse_command_line=function(){this.writeln("");var aCommand=this.command.join("").split(" ");if(aCommand.length>0&&aCommand[0].length>0){this.command_history.push(this.command);var this_command=this._find_command(aCommand[0]);if(this_command&&this_command.callback){if(this_command.callback.call(this,aCommand.length,aCommand))return void(this.current_command=this.command_history.length)}else this.write(aCommand[0]+": "+this.options.commandnotfound);this.writeln("\n")}this.current_command=this.command_history.length,this.lock_input()},Console.prototype._set_Text=function(param){return this.set_text(param.text,param.x,param.y)},Console.prototype.set_text=function(text,x,y){for(var i=0;i<text.length;i++){var car=text[i];if("\n"==car)y++,x=0;else if("\t"==car)for(x+=this.options.tabcols;x%this.options.tabcols!=0;)x++;else this.buffer[this.memmap_addr+y*this.cols+x]=text[i],x++;y>=this.rows&&(this.scroll(1),y=this.rows-1),x>=this.cols&&(this.enable_external_input&&this.grab_extended&&this.last_col.push(x-1),x=0,y++)}return{x:x,y:y}},Console.prototype.scroll=function(lines){this.memmap_addr+=this.cols*lines,this.original_memmap_addr=this.memmap_addr,this.command_start_row--;for(var i=1;i<=lines;i++)for(var j=0;j<this.cols;j++)this.buffer[this.memmap_addr+(this.rows-i)*this.cols+j]=" "},Console.prototype._writeln=function(param){this.writeln(param.text)},Console.prototype.writeln=function(text){this.write(text+"\n")},Console.prototype._write=function(param){this.write(param.text)},Console.prototype.write=function(text){var ret=this.set_text(text,this.current_col,this.current_row);this.current_col=ret.x,this.current_row=ret.y},Console.prototype.draw_buffer=function(){var format,x=0,y=0,x1=0,y1=0;this.ctx.font="normal"+this.options.fontsize+"px "+this.options.fontname;var bkcolor=this.options.bkcolor,color=this.options.color;this.ctx.fillStyle=bkcolor,this.ctx.fillRect(0,0,this.width,this.height);var line_height=this.fontheight%2==0?this.fontheight:this.fontheight+1;this.ctx.textBaseline="middle";for(var i=0;i<this.rows;i++)for(var j=0;j<this.cols;j++)(format=this.addr_format[this.memmap_addr+i*this.cols+j])!=undefined&&(this.ctx.font="normal "+format.fontsize+"px "+format.fontname,bkcolor=format.bkcolor,color=format.color),x1=(x=j*this.fontwidth)+this.fontwidth,y1=(y=i*line_height)+line_height,this.ctx.fillStyle=bkcolor,this.ctx.fillRect(x,y+1,x1-x,y1-y-1),this.ctx.fillStyle=color,this.ctx.fillText(this.buffer[this.memmap_addr+i*this.cols+j],x,(y1+y)/2,this.fontwidth)},Console.prototype.grab_input=function(callback,required,extended,password){this.enable_external_input=!0,this.input=!1,this.command=new Array,this.command_start_col=this.current_col,this.command_start_row=this.current_row,this.external_input_callback=callback,this.grab_extended=extended,this.grab_password=password,this.grab_required=required,this.last_col=new Array},Console.prototype.lock_input=function(){this.write(this.options.prompt+"# "),this.input=!0,this.command=new Array,this.command_start_col=this.current_col,this.command_start_row=this.current_row,this.enable_external_input=!1,this.grab_password=!1,this.last_col=null,this.external_input_callback=null},Console.prototype.unlock_input=function(){this.write("\n"),this.input=!1},Console.prototype.set_property=function(params){var this_options=new Array;for(i in this.options)params[i]?this_options[i]=params[i]:this_options[i]=this.options[i];this.addr_format[this.memmap_addr+this.current_row*this.cols+this.current_col]=this_options},Console.prototype.restore_properties=function(){this.addr_format[this.memmap_addr+this.current_row*this.cols+this.current_col]=this.options},jQuery.extend(Console,{CONSOLE_DEFAULTS:{bkcolor:"#000000",color:"#00FF00",fontname:"courier",fontsize:12,prompt:"root",tabcols:10,helpspaces:"\t",helpcommand:"help",helpcommanddesc:"List all available commands.",clearcommand:"clear",clearcommanddesc:"Clear the console.",commandnotfound:"command not found. Type 'help' to the command list.",oninit:null}});