function Boxy(element,options){this.boxy=jQuery(Boxy.WRAPPER),jQuery.data(this.boxy[0],"boxy",this),this.visible=!1,this.options=jQuery.extend({},Boxy.DEFAULTS,options||{}),this.options.modal&&(this.options=jQuery.extend(this.options,{center:!0,draggable:!1})),this.options.actuator&&jQuery.data(this.options.actuator,"active.boxy",this),this.setContent(element||"<div></div>"),this._setupTitleBar(),this.boxy.css("display","none").appendTo(document.body),this.toTop(),this.options.center&&Boxy._u(this.options.x,this.options.y)?this.center():this.moveTo(Boxy._u(this.options.x)?this.options.x:Boxy.DEFAULT_X,Boxy._u(this.options.y)?this.options.y:Boxy.DEFAULT_Y),this.options.show&&this.show()}jQuery.fn.boxy=function(options){return options=options||{},this.each(function(){var node=this.nodeName.toLowerCase(),self=this;"a"==node?jQuery(this).click(function(){var active=Boxy.linkedTo(this),href=this.getAttribute("href"),localOptions=jQuery.extend({actuator:this,title:this.title},options);if(active)active.show();else if(href.indexOf("#")>=0){var content=jQuery(href.substr(href.indexOf("#")));localOptions.unloadOnHide=!1,new Boxy(content,localOptions)}else localOptions.cache||(localOptions.unloadOnHide=!0),Boxy.load(this.href,localOptions);return!1}):"form"==node&&jQuery(this).bind("submit.boxy",function(){return Boxy.confirm(options.message||"Please confirm:",function(){jQuery(self).unbind("submit.boxy").submit()}),!1})})},Boxy.EF=function(){},jQuery.extend(Boxy,{WRAPPER:"<table cellspacing='0' cellpadding='0' border='0' class='boxy-wrapper'><tr><td class='top-left'></td><td class='top'></td><td class='top-right'></td></tr><tr><td class='left'></td><td class='boxy-inner'></td><td class='right'></td></tr><tr><td class='bottom-left'></td><td class='bottom'></td><td class='bottom-right'></td></tr></table>",DEFAULTS:{title:null,closeable:!0,draggable:!0,clone:!1,actuator:null,center:!0,show:!0,modal:!1,fixed:!0,closeText:"[close]",unloadOnHide:!1,clickToFront:!1,behaviours:Boxy.EF,afterDrop:Boxy.EF,afterShow:Boxy.EF,afterHide:Boxy.EF,beforeUnload:Boxy.EF},DEFAULT_X:50,DEFAULT_Y:50,zIndex:1337,dragConfigured:!1,resizeConfigured:!1,dragging:null,load:function(url,options){options=options||{};var ajax={url:url,type:"GET",dataType:"html",cache:!1,success:function(html){html=jQuery(html),options.filter&&(html=jQuery(options.filter,html)),new Boxy(html,options)}};jQuery.each(["type","cache"],function(){this in options&&(ajax[this]=options[this],delete options[this])}),jQuery.ajax(ajax)},get:function(ele){var p=jQuery(ele).parents(".boxy-wrapper");return p.length?jQuery.data(p[0],"boxy"):null},linkedTo:function(ele){return jQuery.data(ele,"active.boxy")},alert:function(message,callback,options){return Boxy.ask(message,["OK"],callback,options)},confirm:function(message,after,options){return Boxy.ask(message,[options.ok?options.ok:"OK",options.cancel?options.cancel:"Cancel"],function(response){"OK"==response&&after()},options)},ask:function(question,answers,callback,options){options=jQuery.extend({modal:!0,closeable:!1},options||{},{show:!0,unloadOnHide:!0});var body=jQuery("<div></div>").append(jQuery('<div class="question"></div>').html(question)),map={},answerStrings=[];if(answers instanceof Array)for(var i=0;i<answers.length;i++)map[answers[i]]=answers[i],answerStrings.push(answers[i]);else for(var k in answers)map[answers[k]]=k,answerStrings.push(answers[k]);var buttons=jQuery('<form class="answers"></form>');buttons.html(jQuery.map(answerStrings,function(v){return"<input type='button' value='"+v+"' />"}).join(" ")),jQuery("input[type=button]",buttons).on("click",function(){var clicked=this;callback&&callback.call(this,map[clicked.value]),Boxy.get(this).hide(function(){})}),body.append(buttons),new Boxy(body,options),buttons.find("input:first").focus()},isModalVisible:function(){return jQuery(".boxy-modal-blackout").length>0},_u:function(){for(var i=0;i<arguments.length;i++)if("undefined"!=typeof arguments[i])return!1;return!0},_handleResize:function(){var d=jQuery(document);jQuery(".boxy-modal-blackout").css("display","none").css({width:d.width(),height:d.height()}).css("display","block")},_handleDrag:function(evt){var d;(d=Boxy.dragging)&&d[0].boxy.css({left:evt.pageX-d[1],top:evt.pageY-d[2]})},_nextZ:function(){return Boxy.zIndex++},_viewport:function(){var d=document.documentElement,b=document.body,w=window;return jQuery.extend({left:w.pageXOffset,top:w.pageYOffset},Boxy._u(w.innerWidth)?Boxy._u(d)||Boxy._u(d.clientWidth)||0==d.clientWidth?{width:b.clientWidth,height:b.clientHeight}:{width:d.clientWidth,height:d.clientHeight}:{width:w.innerWidth,height:w.innerHeight})}}),Boxy.prototype={estimateSize:function(){this.boxy.css({visibility:"hidden",display:"block"});var dims=this.getSize();return this.boxy.css("display","none").css("visibility","visible"),dims},getSize:function(){return[this.boxy.width(),this.boxy.height()]},getContentSize:function(){var c=this.getContent();return[c.width(),c.height()]},getPosition:function(){var b=this.boxy[0];return[b.offsetLeft,b.offsetTop]},getCenter:function(){var p=this.getPosition(),s=this.getSize();return[Math.floor(p[0]+s[0]/2),Math.floor(p[1]+s[1]/2)]},getInner:function(){return jQuery(".boxy-inner",this.boxy)},getContent:function(){return jQuery(".boxy-content",this.boxy)},setContent:function(newContent){return newContent=jQuery(newContent).css({display:"block"}).addClass("boxy-content"),this.options.clone&&(newContent=newContent.clone(!0)),this.getContent().remove(),this.getInner().append(newContent),this._setupDefaultBehaviours(newContent),this.options.behaviours.call(this,newContent),this},moveTo:function(x,y){return this.moveToX(x).moveToY(y),this},moveToX:function(x){return"number"==typeof x?this.boxy.css({left:x}):this.centerX(),this},moveToY:function(y){return"number"==typeof y?this.boxy.css({top:y}):this.centerY(),this},centerAt:function(x,y){var s=this[this.visible?"getSize":"estimateSize"]();return"number"==typeof x&&this.moveToX(x-s[0]/2),"number"==typeof y&&this.moveToY(y-s[1]/2),this},centerAtX:function(x){return this.centerAt(x,null)},centerAtY:function(y){return this.centerAt(null,y)},center:function(axis){var v=Boxy._viewport(),o=this.options.fixed?[0,0]:[v.left,v.top];return axis&&"x"!=axis||this.centerAt(o[0]+v.width/2,null),axis&&"y"!=axis||this.centerAt(null,o[1]+v.height/2),this},centerX:function(){return this.center("x")},centerY:function(){return this.center("y")},resize:function(width,height,after){if(this.visible){var bounds=this._getBoundsForResize(width,height);return this.boxy.css({left:bounds[0],top:bounds[1]}),this.getContent().css({width:bounds[2],height:bounds[3]}),after&&after(this),this}},tween:function(width,height,after){if(this.visible){var bounds=this._getBoundsForResize(width,height),self=this;return this.boxy.stop().animate({left:bounds[0],top:bounds[1]}),this.getContent().stop().animate({width:bounds[2],height:bounds[3]},function(){after&&after(self)}),this}},isVisible:function(){return this.visible},show:function(){if(!this.visible){if(this.options.modal){var self=this;Boxy.resizeConfigured||(Boxy.resizeConfigured=!0,jQuery(window).resize(function(){Boxy._handleResize()})),this.modalBlackout=jQuery('<div class="boxy-modal-blackout"></div>').css({zIndex:Boxy._nextZ(),opacity:.7,width:jQuery(document).width(),height:jQuery(document).height()}).appendTo(document.body),this.toTop(),this.options.closeable&&jQuery(document.body).bind("keypress.boxy",function(evt){27==(evt.which||evt.keyCode)&&(self.hide(),jQuery(document.body).unbind("keypress.boxy"))})}return this.boxy.stop().css({opacity:1}).show(),this.visible=!0,this._fire("afterShow"),this}},hide:function(after){if(this.visible){var self=this;return this.options.modal&&(jQuery(document.body).unbind("keypress.boxy"),this.modalBlackout.animate({opacity:0},function(){jQuery(this).remove()})),this.boxy.stop().animate({opacity:0},300,function(){self.boxy.css({display:"none"}),self.visible=!1,self._fire("afterHide"),after&&after(self),self.options.unloadOnHide&&self.unload()}),this}},toggle:function(){return this[this.visible?"hide":"show"](),this},hideAndUnload:function(after){return this.options.unloadOnHide=!0,this.hide(after),this},unload:function(){this._fire("beforeUnload"),this.boxy.remove(),this.options.actuator&&jQuery.data(this.options.actuator,"active.boxy",!1)},toTop:function(){return this.boxy.css({zIndex:Boxy._nextZ()}),this},getTitle:function(){return jQuery("> .title-bar h2",this.getInner()).html()},setTitle:function(t){return jQuery("> .title-bar h2",this.getInner()).html(t),this},_getBoundsForResize:function(width,height){var csize=this.getContentSize(),delta=[width-csize[0],height-csize[1]],p=this.getPosition();return[Math.max(p[0]-delta[0]/2,0),Math.max(p[1]-delta[1]/2,0),width,height]},_setupTitleBar:function(){if(this.options.title){var self=this,tb=jQuery("<div class='title-bar'></div>").html("<h2>"+this.options.title+"</h2>");this.options.closeable&&tb.append(jQuery("<a href='#' class='close'></a>").html(this.options.closeText)),this.options.draggable&&(tb[0].onselectstart=function(){return!1},tb[0].unselectable="on",tb[0].style.MozUserSelect="none",Boxy.dragConfigured||(jQuery(document).mousemove(Boxy._handleDrag),Boxy.dragConfigured=!0),tb.mousedown(function(evt){self.toTop(),Boxy.dragging=[self,evt.pageX-self.boxy[0].offsetLeft,evt.pageY-self.boxy[0].offsetTop],jQuery(this).addClass("dragging")}).mouseup(function(){jQuery(this).removeClass("dragging"),Boxy.dragging=null,self._fire("afterDrop")})),this.getInner().prepend(tb),this._setupDefaultBehaviours(tb)}},_setupDefaultBehaviours:function(root){var self=this;this.options.clickToFront&&root.click(function(){self.toTop()}),jQuery(".close",root).click(function(){return self.hide(),!1}).mousedown(function(evt){evt.stopPropagation()})},_fire:function(event){this.options[event].call(this)}};