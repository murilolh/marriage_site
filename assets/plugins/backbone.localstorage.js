!function(root,factory){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(_,Backbone){return factory(_||root._,Backbone||root.Backbone)}):factory(_,Backbone)}(this,function(_,Backbone){function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}return Backbone.LocalStorage=window.Store=function(name){this.name=name;var store=null;(store=window.contentStore?window.contentStore[this.name]:this.localStorage().getItem(this.name))&&(store=JSON.parse(store)),this.records=store||[]},_.extend(Backbone.LocalStorage.prototype,{save:function(){window.contentStore?window.contentStore[this.name]=JSON.stringify(this.records):this.localStorage().setItem(this.name,JSON.stringify(this.records))},create:function(model){return model.id||(model.id=guid(),model.set(model.idAttribute,model.id)),this.records.push(model),window.contentStore?window.contentStore[this.name]=JSON.stringify(this.records):this.localStorage().setItem(this.name,JSON.stringify(this.records)),this.save(),this.find(model)},update:function(model){var filter={};filter[this.model.idAttribute]=this.model.id;var record=_.where(this.records,filter);if(record){for(var i in model)record[i]=model[i];window.contentStore?window.contentStore[this.name]=JSON.stringify(this.records):this.localStorage().setItem(this.name,JSON.stringify(this.records))}else this.records.push(model),this.save();return this.find(model)},find:function(model){var records=null;if(records=window.contentStore?window.contentStore[this.name]:this.localStorage().getItem(this.name))try{records=JSON.parse(records)}catch(e){}var ret=_.where(records,model);return 1==ret.length&&(ret=ret[0]),ret},findAll:function(){return this.records},destroy:function(model){return!model.isNew()&&(this.save(),this.records=_.reject(this.records,function(id){return id===model.id.toString()}),this.save(),model)},localStorage:function(){return window.contentStore?{getItem:function(name){return window.contentStore[name]},setItem:function(name,value){window.contentStore[name]=value}}:localStorage||{getItem:function(){return""},setItem:function(){}}},jsonData:function(data){return data&&JSON.parse(data)},_clear:function(){var local=this.localStorage(),itemRe=new RegExp("^"+this.name+"-");local.removeItem(this.name),_.chain(local).keys().filter(function(k){return itemRe.test(k)}).each(function(k){local.removeItem(k)})},_storageSize:function(){return this.localStorage().length}}),Backbone.LocalStorage.sync=window.Store.sync=Backbone.localSync=function(method,model,options){var resp,errorMessage,store=model.localStorage||model.collection.localStorage,syncDfd=$.Deferred&&$.Deferred();try{var record=options.data||model.toJSON();switch(method){case"read":resp=record?store.find(record):store.findAll();break;case"create":resp=store.create(record);break;case"update":resp=store.update(record);break;case"delete":resp=store.destroy(record)}}catch(error){errorMessage=error.code===DOMException.QUOTA_EXCEEDED_ERR&&0===store._storageSize()?"Private browsing is unsupported":error.message}return resp?(model.trigger("sync",model,resp,options),options&&options.success&&("0.9.10"===Backbone.VERSION?options.success(model,resp,options):options.success(resp)),syncDfd&&syncDfd.resolve(resp)):(errorMessage=errorMessage||"Record Not Found",model.trigger("error",model,errorMessage,options),options&&options.error&&("0.9.10"===Backbone.VERSION?options.error(model,errorMessage,options):options.error(errorMessage)),syncDfd&&syncDfd.reject(errorMessage)),options&&options.complete&&options.complete(JSON.stringify(resp)),syncDfd&&syncDfd.promise()},Backbone.ajaxSync=Backbone.sync,Backbone.getSyncMethod=function(model){return model.localStorage||model.collection&&model.collection.localStorage?Backbone.localSync:Backbone.ajaxSync},Backbone.sync=function(method,model,options){return Backbone.getSyncMethod(model).apply(this,[method,model,options])},Backbone.LocalStorage});