var PostViewV2=null;!function($){PostViewV2=BaseBackboneView.extend({events:{"click .comments-link":"toggleComments","click .close-comments":"toggleComments","click .write-comment":"writeComment","submit #comentario_form":"add_comment","click .ico-refresh":"changeCaptcha"},changeCaptcha:function(){this.options.captcha.fetch({data:{object:"comment"},success:function(){}})},drawCaptcha:function(){$("input[name='captcha_key']").val(this.options.captcha.get("key")),$(".captcha img").attr("src",this.options.captcha.get("image"))},writeComment:function(ev){var post_id=$(ev.currentTarget).attr("postid"),write_element=$("#write_window");this.$el.find(".write-window-area").prepend(write_element);var comments=$("div[commentpostid='"+post_id+"']");write_element.find(".def-result-message").removeClass("error").removeClass("success").hide(),write_element.find("input[name='nome']").val(""),write_element.find("input[name='email']").val(""),write_element.find("input[name='comentario']").val(""),write_element.find("input[name='captcha']").val(""),write_element.find("*[data-field]").parent(".cnt").removeClass("error").find(".txt-error").hide(),write_element.attr("postid")==this.model.get("id_template_blog_post")?write_element.toggle():write_element.show(),comments.is(":visible")&&write_element.is(":visible")&&comments.hide(),write_element.find("#nome").focus(),write_element.attr("postid",this.model.get("id_template_blog_post")),write_element.find("#id_template_blog_post").val(this.model.get("id_template_blog_post")),this.delegateEvents(),this.changeCaptcha()},toggleComments:function(ev){var post_id=$(ev.currentTarget).attr("postid"),el=$("div[commentpostid='"+post_id+"']"),write_element=$("#write_window");el.toggle(),el.is(":visible")&&write_element.is(":visible")&&write_element.hide()},add_comment:function(){var self=this,id_noivo=this.options.noivos.get("id_noivo"),id_template_blog_post=$("#comentario_form #id_template_blog_post").val(),nome=$("#comentario_form #nome").val(),email=$("#comentario_form #email").val(),message=$("#comentario_form #comentario").val(),captcha=$("#comentario_form #captcha").val(),captcha_key=$("#comentario_form #captcha_key").val();$("*[data-field]").parent(".cnt").removeClass("error").find(".txt-error").hide();var obj={nome:nome,email:email,mensagem:message,captcha:captcha,captcha_key:captcha_key,id_noivo:id_noivo,id_template_blog_post:id_template_blog_post},Assert=Validator.Assert,validator=new Validator.Validator,constraints={nome:(new Assert).NotBlank(),email:(new Assert).Email(),mensagem:(new Assert).NotBlank(),captcha:(new Assert).NotBlank(),captcha_key:(new Assert).NotBlank(),id_noivo:(new Assert).NotNull(),id_template_blog_post:(new Assert).NotNull()},validations=validator.validate(obj,constraints);if(1==validations){var comment_obj=new TemplateBlogComentario;window.loading.jLoading("block",!0),comment_obj.save(obj,{wait:!0,success:function(model){window.loading.jLoading("block",!1),$("#comentario_form #nome").val(""),$("#comentario_form #email").val(""),$("#comentario_form #comentario").val(""),$("#comentario_form #captcha").val(""),self.changeCaptcha();var msg=I18n.t("blogs.comment_sent");if(0==comment_obj.get("status")&&(msg+="<br/>"+I18n.t("blogs.comment_waiting")),$(".def-result-message").removeClass("error").addClass("success"),$(".def-result-message").html(msg),$(".def-result-message").show(),0!=comment_obj.get("status")){(model=self.model).get("comentarios").push(comment_obj.attributes);var length=model.get("comentarios").length;self.$el.find(".comments-qtd").html(""+length);var comment_html=render_template("template_blog_comment_id","/templates/backbone/"+self.options.noivos.get("id_noivo")+"/blog/"+self.options.noivos.get("template_html_version")+"/comment",{noivos:self.options.noivos.attributes,comentario:comment_obj.attributes});self.$el.find(".msgs-area").prepend($(comment_html))}var top=self.$el.find(".write-comment").position().top;$("html,body").animate({scrollTop:top},200),$("#cnt-comentario").text("4000")},error:function(model,xhr){window.loading.jLoading("block",!1);var response=xhr.responseText,response_obj=JSON.parse(response);for(var i in response_obj.errors){var error=response_obj.errors[i];$("*[data-field='"+error.key+"']").parent(".cnt").addClass("error").find(".txt-error").html(error.value).show()}$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show();var top=self.$el.find(".write-comment").position().top;$("html,body").animate({scrollTop:top},200)}})}else{for(validation in validations){var field=validation;"mensagem"==field&&(field="comentario"),$("*[data-field='"+field+"']").parent(".cnt").addClass("error").find(".txt-error").html(I18n.t("validatorjs."+validations[validation][0].assert.__class__.toLowerCase())).show()}$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show(),$("html,body").animate({scrollTop:0},200)}},initialize:function(){this.remove(),this.constructor.__super__.initialize.call(this);var self=this;this.adopted=!0,this.options.captcha.on("change",this.drawCaptcha,this);var item=$("li[postid='"+this.model.get("id_template_blog_post")+"']");item.get(0)?this.setElement(item):(this.adopted=!1,render_template("template_blog_load_more_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/blog/"+this.options.noivos.get("template_html_version")+"/load_more",{noivos:this.options.noivos.attributes,post:this.options.model.attributes},function(ret){self.setElement(ret),self.options.onload&&self.options.onload.call(self)}))},render:function(){return this}})}(jQuery);