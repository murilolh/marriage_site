var BlogView=null;!function($){BlogView=BaseBackboneView.extend({events:{"click #close_write_window":"closeWriteWindow","click .ico-refresh":"changeCaptcha"},closeWriteWindow:function(){$("#write_window").hide()},changeCaptcha:function(){this.options.captcha.fetch({data:{object:"comment"},success:function(){}})},drawCaptcha:function(){$("input[name='captcha_key']").val(this.options.captcha.get("key")),$(".captcha img").attr("src",this.options.captcha.get("image"))},initialize:function(){this.constructor.__super__.initialize.call(this);var self=this;this.adopted=!0,this.posts_view=new Array,this.options.captcha.on("change",this.drawCaptcha,this);var item=$(".template-blog-"+this.options.entries.get("pagination").pag_atual);item.get(0)?(this.setElement(item),self.options.onload&&self.options.onload.call(self)):(this.adopted=!1,render_template("template_pagination_blog_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/pagination/default",{noivos:this.options.noivos.attributes,pages_info:this.options.entries.get("pagination")},function(pages_html){render_template("template_blog_id","/templates/backbone/"+self.options.noivos.get("id_noivo")+"/blog/"+self.options.noivos.get("template_html_version")+"/index",{noivos:self.options.noivos.attributes,entries:self.options.entries.attributes,pages_html:pages_html,pagina:self.options.pagina.attributes,captcha:self.options.captcha.attributes},function(ret){self.setElement(ret),self.options.onload&&self.options.onload.call(self)})}))},render:function(){var self=this;self.drawCaptcha();var entries=this.options.entries.get("entries");for(i in entries){var entry=entries[i],post=new TemplateBlogPost(entry),subview=new PostView({model:post});this.posts_view[post.get("id_template_blog_post")]=subview}return load_css("//assets1.icasei.com.br/assets/formhelper.css"),load_js("//assets1.icasei.com.br/assets/formhelper.js",function(){$("#comentario").formhelper({defaultField:"nome",autoRender:!1,onSubmitError:function(){$("#write_window").find(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$("#write_window").find(".def-result-message").addClass("error").removeClass("success"),$("#write_window").find(".def-result-message").show()},onSubmit:function(){this.getData();var id_noivo=self.options.noivos.get("id_noivo"),id_template_blog_post=$("#comentario #id_template_blog_post").val(),nome=$("#comentario #nome").val(),email=$("#comentario #email").val(),message=$("#comentario #comentario").val(),captcha=$("#comentario #captcha").val(),captcha_key=$("#comentario #captcha_key").val(),comment_obj=new TemplateBlogComentario;return window.loading.jLoading("block",!0),comment_obj.save({nome:nome,email:email,message:message,captcha:captcha,captcha_key:captcha_key,id_noivo:id_noivo,id_template_blog_post:id_template_blog_post},{wait:!0,success:function(model){window.loading.jLoading("block",!1),$("#comentario").formhelper("setvalue","nome",""),$("#comentario").formhelper("setvalue","email",""),$("#comentario").formhelper("setvalue","comentario",""),$("#comentario").formhelper("setvalue","captcha","");var msg=I18n.t("blogs.comment_sent");if(0==comment_obj.get("status")&&(msg+="<br/>"+I18n.t("blogs.comment_waiting")),$("#write_window").find(".def-result-message").removeClass("error").addClass("success"),$("#write_window").find(".def-result-message").html(msg),$("#write_window").find(".def-result-message").show(),0!=comment_obj.get("status")){var view=self.posts_view[comment_obj.get("id_template_blog_post")];(model=view.model).get("comentarios").push(comment_obj.attributes);var length=model.get("comentarios").length;view.$el.find(".comments_qtd").html(""+length);var comment_html=render_template("template_blog_comment_id","/templates/backbone/"+self.options.noivos.get("id_noivo")+"/blog/comment",{noivos:self.options.noivos.attributes,comentario:comment_obj.attributes});view.$el.find(".def-comments").prepend($(comment_html))}},error:function(model,xhr){window.loading.jLoading("block",!1);var response=xhr.responseText,response_obj=JSON.parse(response);for(var i in response_obj.errors){var error=response_obj.errors[i];$("#comentario").formhelper("flagerror",error.key,error.value)}$("#write_window").find(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$("#write_window").find(".def-result-message").addClass("error").removeClass("success"),$("#write_window").find(".def-result-message").show()}}),!1}}),$("#comentario").formhelper("init")}),this}})}(jQuery);