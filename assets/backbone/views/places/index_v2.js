var PlacesViewV2=null;!function($){PlacesViewV2=BaseBackboneView.extend({events:{"submit form":"trace_route"},initialize:function(){this.constructor.__super__.initialize.call(this);var self=this;this.adopted=!0;var item=$(".template-local-"+this.options.pagina.get("id_recurso"));item.get(0)?(this.setElement(item),self.options.onload&&self.options.onload.call(self)):(this.adopted=!1,render_template("template_places_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/places/"+this.options.noivos.get("template_html_version")+"/index",{noivos:this.options.noivos.attributes,local:this.options.local.attributes,pagina:this.options.pagina.attributes},function(ret){self.setElement(ret),self.options.onload&&self.options.onload.call(self)}))},render:function(){var self=this;return $("body").unbind("gmap_loaded").bind("gmap_loaded",function(){if(self.geocoder=new google.maps.Geocoder,self.options.local.get("googleMaps")||self.options.local.get("googlemaps"))if(null!==self.options.local.get("lat")&&null!==self.options.local.get("lng")){var position=new google.maps.LatLng(self.options.local.get("lat"),self.options.local.get("lng"));self.destination_address=position,self.initialize_gmaps(position,function(){setTimeout(function(){self.show_address_marker()},500)})}else{var endereco=self.options.local.get("endereco")+","+self.options.local.get("numero")+","+self.options.local.get("cidade")+","+self.options.local.get("estado")+","+self.options.local.get("pais");self.find_address(endereco,function(status,position){status&&(self.destination_address=position,self.initialize_gmaps(position,function(){setTimeout(function(){self.show_address_marker()},500)}))})}}),loadGoogleMapsApi(),this},trace_route:function(){var self=this,souce_str=$("#origem").val();$(".loading").jLoading("start"),$(".def-result-message").html("").hide(),this.find_address(souce_str,function(status,position){if(status){var request={origin:position,destination:self.destination_address,travelMode:google.maps.TravelMode.DRIVING};(new google.maps.DirectionsService).route(request,function(result,status){if(status==google.maps.DirectionsStatus.OK){self.directionsDisplay.setDirections(result);var direction=null;if(result.routes.length>0){var route=result.routes[0];if(route.legs.length>0){var leg=route.legs[0],steps=new Array;for(var i in leg.steps){var step=leg.steps[i];steps.push({info:step.instructions,distance:step.distance.text,duration:step.duration.text})}direction={start_address:leg.start_address,end_address:leg.end_address,distance:leg.distance.text,duration:leg.duration.text,steps:steps}}}render_template("template_places_direction_id","/templates/backbone/"+self.options.noivos.get("id_noivo")+"/places/"+self.options.noivos.get("template_html_version")+"/direction",{direction:direction},function(address_html){$("#directions").empty(),$("#directions").append($(address_html)),$("#directions").show(),$(".loading").jLoading("stop")})}else $(".loading").jLoading("stop"),$(".def-result-message").html(I18n.t("places.errors.directions")).addClass("error").show()})}else $(".loading").jLoading("stop"),$(".def-result-message").html(I18n.t("places.errors.address")).addClass("error").show()})},get_address_html:function(callback){render_template("template_places_address_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/places/"+this.options.noivos.get("template_html_version")+"/address",{noivos:this.options.noivos.attributes,local:this.options.local.attributes,pagina:this.options.pagina.attributes},callback)},show_address_marker:function(){var self=this;this.marker.info_window&&(this.marker.info_window.close(),this.marker.info_window=null),this.marker.info_window=new google.maps.InfoWindow,google.maps.event.addListener(this.marker.info_window,"closeclick",function(){self.marker.info_window=null}),this.get_address_html(function(html){self.marker.info_window.setContent(html),self.marker.info_window.open(self.map,self.marker)})},find_address:function(address,callback){address&&""!=address?this.geocoder&&this.geocoder.geocode({address:address},function(results,status){status==google.maps.GeocoderStatus.OK?callback&&callback(!0,results[0].geometry.location):callback&&callback(!1)}):callback&&callback(!1)},initialize_gmaps:function(position,callback){var self=this,myOptions={zoom:17,center:position,mapTypeId:google.maps.MapTypeId.ROADMAP};$(document).ready(function(){var $map,$cover;$(".map_canvas").length>0&&(self.map=new google.maps.Map($(".map_canvas").get(0),myOptions),self.directionsDisplay=new google.maps.DirectionsRenderer,self.directionsDisplay.setMap(self.map),self.marker=new google.maps.Marker({map:self.map,position:position,draggable:!1,zIndex:1e3}),self.marker.info_window=null,google.maps.event.addListener(self.marker,"position_changed",function(){}),google.maps.event.addListener(self.marker,"click",function(){self.show_address_marker()}),google.maps.event.addListener(self.map,"click",function(){}),$map=$(".map_canvas"),$cover=$('<div class="cover"></div>'),$map.append($cover),$cover.on("click",function(){$cover.remove()}),callback&&callback.call(self),google.maps.event.trigger(self.map,"resize"))})}})}(jQuery);