var HintsView=null;!function($){HintsView=BaseBackboneView.extend({initialize:function(){this.constructor.__super__.initialize.call(this);var self=this,item=$("#dicas");this.adopted=!0,item.get(0)?(this.setElement(item),self.options.onload&&self.options.onload.call(self)):(this.adopted=!1,render_template("template_hints_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/hints/"+this.options.noivos.get("template_html_version")+"/index",{noivos:this.options.noivos.attributes,pagina:this.options.pagina.attributes},function(ret){self.setElement(ret),self.options.onload&&self.options.onload.call(self)}))},render:function(){var self=this;map_item=$(".map_canvas");var cover=$('<div class="cover"></div>');return cover.on("click",function(){$(this).remove()}),map_item.append(cover),load_css("//assets1.icasei.com.br/assets/formhelper.css"),load_js("//assets1.icasei.com.br/assets/formhelper.js",function(){var d,dica,item_dica,item_dica_index,dicas=self.options.pagina.attributes.conteudo;for(d in dicas)if(8==(dica=dicas[d]).id_tipo_conteudo)for(item_dica_index in dados=jQuery.parseJSON(dica.conteudo).data,dados)item_dica=dados[item_dica_index],$("#map-"+item_dica.id_dica),directionsElem=$("#direction-"+item_dica.id_dica),$(directionsElem).formhelper({defaultField:"nome",autoRender:!1,messages:form_helper_messages,onSubmitError:function(){Boxy.alert(I18n.t("formhelper.formhelper_invalid_values"),function(){},{title:"ERRO",closeText:"[Fechar]"})},onSubmit:function(){console.log("submited")}}),$(directionsElem).formhelper("init")}),$("body").unbind("gmap_loaded").bind("gmap_loaded",function(){var d,dica,arrayDica,mapElem;self.geocoder=new google.maps.Geocoder;var dicas=self.options.pagina.attributes.conteudo,maxSyncRequests=5;for(d in getRandomTimeout=function(baseTimeout){return 1e3*baseTimeout+Math.round(800*Math.random())},dicas)if(8==(dica=dicas[d]).id_tipo_conteudo){var dadosParse=jQuery.parseJSON(dica.conteudo).data;for(arrayDica=0;arrayDica<dadosParse.length;arrayDica++)dados=dadosParse[arrayDica],mapElem=$("#map-"+dados.id_dica),$("#tracar-rota-"+dados.id_dica),dados.googleMaps&&dados.lat&&dados.lng&&function(dados){var params,position=new google.maps.LatLng(dados.lat,dados.lng);dados.destination_address=position,dados.traceRoute=function(){self.trace_route(dados)},dados.endereco?setTimeout((params={mapElem:mapElem,dados:dados,position:position},function(){self.initialize_gmaps(params.mapElem,params.dados,params.position,function(mapData){setTimeout(function(){self.show_address_marker(params.dados,mapData)},500)})}),d<maxSyncRequests?0:getRandomTimeout(d)):self.geocoder.geocode({location:position},function(results,status){if(status==google.maps.GeocoderStatus.OK){mapElem=$("#map-"+dados.id_dica);var address=results[0].address_components;dados.endereco=address[1].short_name,dados.numero=address[0].short_name,dados.cidade=address[3].short_name,dados.estado=address[5].short_name,dados.pais=address[6].long_name,setTimeout((params={mapElem:mapElem,dados:dados,position:position},function(){self.initialize_gmaps(params.mapElem,params.dados,params.position,function(mapData){setTimeout(function(){self.show_address_marker(params.dados,mapData)},500)})}),d<maxSyncRequests?0:getRandomTimeout(d))}else console.log(status);var params})}(dados)}}),loadGoogleMapsApi(),this},trace_route:function(dica){var self=this,souce_str=$("#origem-"+dica.id_dica).val();$(".loading").jLoading("start"),$("#def-result-message-"+dica.id_dica).html("").hide(),this.find_address(souce_str,function(status,position){if(status){var request={origin:position,destination:dica.destination_address,travelMode:google.maps.TravelMode.DRIVING};(new google.maps.DirectionsService).route(request,function(result,status){if(status==google.maps.DirectionsStatus.OK){dica.directionsDisplay.setDirections(result);var direction=null;if(result.routes.length>0){var route=result.routes[0];if(route.legs.length>0){var leg=route.legs[0],steps=new Array;for(var i in leg.steps){var step=leg.steps[i];steps.push({info:step.instructions,distance:step.distance.text,duration:step.duration.text})}direction={start_address:leg.start_address,end_address:leg.end_address,distance:leg.distance.text,duration:leg.duration.text,steps:steps}}}var directionsElem=$("#directions-"+dica.id_dica);render_template("template_places_direction_id","/templates/backbone/"+self.options.noivos.get("id_noivo")+"/hints/"+self.options.noivos.get("template_html_version")+"/direction",{direction:direction},function(address_html){$(directionsElem).empty(),$(directionsElem).append($(address_html)),$(directionsElem).show(),$(".loading").jLoading("stop")})}else $(".loading").jLoading("stop"),$("#def-result-message-"+dica.id_dica).html(I18n.t("places.errors.directions")).addClass("error").show()})}else $(".loading").jLoading("stop"),$("#def-result-message-"+dica.id_dica).html(I18n.t("places.errors.address")).addClass("error").show()})},get_address_html:function(dica,callback){render_template("template_places_address_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/hints/"+this.options.noivos.get("template_html_version")+"/address",{noivos:this.options.noivos.attributes,dica:dica,pagina:this.options.pagina.attributes},callback)},show_address_marker:function(dica,mapData){mapData.marker.info_window&&(mapData.marker.info_window.close(),mapData.marker.info_window=null),mapData.marker.info_window=new google.maps.InfoWindow,google.maps.event.addListener(mapData.marker.info_window,"closeclick",function(){mapData.marker.info_window=null}),this.get_address_html(dica,function(html){mapData.marker.info_window.setContent(html),mapData.marker.info_window.open(mapData.map,mapData.marker)})},find_address:function(address,callback){address&&""!=address?this.geocoder&&this.geocoder.geocode({address:address},function(results,status){status==google.maps.GeocoderStatus.OK?callback&&callback(!0,results[0].geometry.location):callback&&callback(!1)}):callback&&callback(!1)},initialize_gmaps:function(mapElem,dica,position,callback){var self=this,myOptions={zoom:17,center:position,mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map(mapElem.get(0),myOptions);dica.directionsDisplay=new google.maps.DirectionsRenderer,dica.directionsDisplay.setMap(map);var marker=new google.maps.Marker({map:map,position:position,draggable:!1,zIndex:1e3});marker.info_window=null,google.maps.event.addListener(marker,"position_changed",function(){}),google.maps.event.addListener(marker,"click",function(){self.show_address_marker(dica)}),google.maps.event.addListener(map,"click",function(){});var coverElem=$('<div class="cover"></div>');mapElem.append(coverElem),coverElem.on("click",function(){coverElem.remove()}),callback&&callback.call(this,{map:map,directionsDisplay:dica.directionsDisplay,marker:marker}),google.maps.event.trigger(map,"resize")}})}(jQuery);