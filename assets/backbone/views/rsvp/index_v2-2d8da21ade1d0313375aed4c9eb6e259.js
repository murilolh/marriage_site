var RsvpViewV2=null;!function($){RsvpViewV2=BaseBackboneView.extend({events:{"click  .send-form":"submitForm"},initialize:function(){this.constructor.__super__.initialize.call(this);var self=this;this.adopted=!0;var item=$(".template-rsvp");if(item.get(0))this.setElement(item),self.options.onload&&self.options.onload.call(self);else{var convidado=null;this.adopted=!1,render_template("template_rsvp_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/rsvp/"+this.options.noivos.get("template_html_version")+"/index",{noivos:this.options.noivos.attributes,rsvp_config:this.options.rsvp_config.attributes,pagina:this.options.pagina.attributes,convidado:convidado},function(ret){self.setElement(ret),self.options.onload&&self.options.onload.call(self)})}},save_rsvp:function(){var self=this,nome=$(".confirmacao input[name='nome']").val(),evento=$(".confirmacao input[name='evento']:checked").val(),adultos=$(".confirmacao select[name='adultos'] option:selected").val(),criancas=$(".confirmacao select[name='criancas'] option:selected").val(),email=$(".confirmacao input[name='email']").val(),ddd=$(".confirmacao input[name='ddd']").val(),telefone=$(".confirmacao input[name='telefone']").val(),acompanhantes=$(".confirmacao textarea[name='acompanhantes']").val();$("#confirm-button-rsvp").prop("disabled",!0).val(I18n.t("rsvp.buttons.waiting"));var id_convidado=0;self.options.convidado&&(id_convidado=self.options.convidado.get("id_convidado"));var Assert=Validator.Assert,validator=new Validator.Validator,constraints={id_noivo:(new Assert).NotNull(),nome:(new Assert).NotBlank(),email:(new Assert).Email(),evento:(new Assert).NotNull(),qtd_pessoas:(new Assert).NotNull(),ddd:(new Assert).NotBlank(),telefone:(new Assert).NotBlank(),acompanhantes:(new Assert).NotBlank()};1==adultos&&(constraints.acompanhantes=null);var obj={id_noivo:self.options.noivos.get("id_noivo"),nome:nome,evento:evento,qtd_pessoas:adultos,criancas:criancas,convidado:"noiva",email:email,ddd:ddd,telefone:telefone,acompanhantes:acompanhantes,id_convidado:id_convidado};for(var i in $(".def-result-message").removeClass("error").html(""),constraints)$("*[data-field='"+i+"']").parent(".cnt").removeClass("error").find(".txt-error").html("").show();var validations=validator.validate(obj,constraints);if(1==validations){var template_rsvp=new TemplateRsvp;window.loading.jLoading("block",!0),template_rsvp.save(obj,{wait:!0,success:function(){$("#confirm-button-rsvp").prop("disabled",!1).val(I18n.t("rsvp.buttons.confirm")),window.loading.jLoading("block",!1),self.options.convidado=null;render_template("template_rsvp_id","/templates/backbone/"+self.options.noivos.get("id_noivo")+"/rsvp/"+self.options.noivos.get("template_html_version")+"/index",{noivos:self.options.noivos.attributes,rsvp_config:self.options.rsvp_config.attributes,pagina:self.options.pagina.attributes,convidado:null},function(ret){self.setElement(ret),change_content(ret,function(){self.render(),$(".send-form").off("click").on("click",function(){self.submitForm()}),$(".def-result-message").addClass("success").removeClass("error"),$(".def-result-message").html(I18n.t("rsvp.messages.success.success")),$(".def-result-message").show()},{template:"front",noivos:self.options.noivos,destroy_view:!1})})},error:function(model,xhr){$("#confirm-button-rsvp").prop("disabled",!1).val(I18n.t("rsvp.buttons.confirm")),window.loading.jLoading("block",!1);var response=xhr.responseText,response_obj=JSON.parse(response);for(var i in constraints)$("*[data-field='"+i+"']").parent(".cnt").removeClass("error").find(".txt-error").html("").show();for(var i in response_obj.errors){var error=response_obj.errors[i];$("*[data-field='"+error.key+"']").parent(".cnt").addClass("error").find(".txt-error").html(error.value).show()}$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show();var top=$(".txt-anchor").offset().top;$("html,body").animate({scrollTop:top},200)}})}else{for(var i in constraints)$("*[data-field='"+i+"']").parent(".cnt").removeClass("error").find(".txt-error").html("").show();for(validation in validations)$("*[data-field='"+validation+"']").parent(".cnt").addClass("error").find(".txt-error").html(I18n.t("validatorjs."+validations[validation][0].assert.__class__.toLowerCase())).show();$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show();var top=$(".txt-anchor").offset().top;$("html,body").animate({scrollTop:top},200),$("#confirm-button-rsvp").prop("disabled",!1).val(I18n.t("rsvp.buttons.confirm"))}},submitForm:function(){if("true"==get_meta("CD"))return!1;var self=this;if(1!=self.options.rsvp_config.get("aberto")||self.options.convidado)self.save_rsvp();else{var nome=$(".confirmacao #nome").val(),Assert=Validator.Assert,validator=new Validator.Validator,constraint={nome:(new Assert).NotBlank()},validations=validator.validate({nome:nome},constraint);if(1==validations){var template_rsvp_convidado=new TemplateRsvpConvidado;window.loading.jLoading("block",!0),template_rsvp_convidado.fetch({data:{id_noivo:self.options.noivos.get("id_noivo"),nome:nome},success:function(){if(window.loading.jLoading("block",!1),template_rsvp_convidado.get("error")){$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("rsvp.messages.error.not_found")),$(".def-result-message").show();var top=$(".txt-anchor").offset().top;$("html,body").animate({scrollTop:top},200)}else $(".def-result-message").hide(),self.options.convidado=template_rsvp_convidado,self.options.convidado&&render_template("template_rsvp_form_id","/templates/backbone/"+self.options.noivos.get("id_noivo")+"/rsvp/"+self.options.noivos.get("template_html_version")+"/index",{noivos:self.options.noivos.attributes,rsvp_config:self.options.rsvp_config.attributes,pagina:self.options.pagina.attributes,convidado:self.options.convidado.attributes},function(ret){change_content(ret,function(){self.setElement(ret),self.render();var top=$(".txt-anchor").offset().top;$("html,body").animate({scrollTop:top},200),$(".send-form").off("click").on("click",function(){self.save_rsvp()})},{template:"front",noivos:self.options.noivos,destroy_view:!1})})},error:function(){window.loading.jLoading("block",!1),$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("rsvp.messages.error.error")),$(".def-result-message").show();var top=$(".txt-anchor").offset().top;$("html,body").animate({scrollTop:top},200)}})}else{for(validation in validations)$("*[data-field='"+validation+"']").parent(".cnt").addClass("error").find(".txt-error").html(I18n.t("validatorjs."+validations[validation][0].assert.__class__.toLowerCase())).show();$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show();var top=$(".txt-anchor").offset().top;$("html,body").animate({scrollTop:top},200)}}},render:function(){$("#acompanhantes").ready(function(){$("#acompanhantes").keyup(function(){var len=this.value.length;len>=4e3&&(this.value=this.value.substring(0,4e3)),$("#cnt-comentario").text(4e3-len)})});var self=this;return load_js("//assets1.icasei.com.br/assets/plugins/validator.js",function(){self.delegateEvents()}),this}})}(jQuery);