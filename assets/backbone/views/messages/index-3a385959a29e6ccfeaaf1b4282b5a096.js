var MessagesView=null;!function($){MessagesView=BaseBackboneView.extend({events:{"click .ico-refresh":"changeCaptcha"},initialize:function(){this.constructor.__super__.initialize.call(this);var self=this;this.adopted=!0,this.options.captcha.on("change",this.drawCaptcha,this),this.options.messages.on("add",this.addMessage,this);var item=$(".template-messages");item.get(0)?(this.messages=[],this.setElement(item),this.options.onload&&this.options.onload.call(self)):(this.adopted=!1,render_template("template_message_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/messages/"+this.options.noivos.get("template_html_version")+"/index",{noivos:this.options.noivos.attributes,messages:this.options.messages.toJSON(),pagina:this.options.pagina.attributes,captcha:this.options.captcha.attributes},function(ret){self.messages=[],self.setElement(ret),self.options.onload&&self.options.onload.call(self)}))},addMessage:function(model){var self=this;new MessageView({noivos:this.options.noivos,message:model,onload:function(){this.render(),this.adopted||0!=model.get("aprovada")&&($(".no-message").remove(),$(".def-messages").prepend(this.$el),this.$el.addClass("start_vertical_roll_animation")),self.messages[model.get("id_template_msg_noivos")]=this;var msg=I18n.t("messages.message_sent");0==model.get("aprovada")&&(msg+="<br/>"+I18n.t("messages.message_waiting")),$(".def-result-message").html(msg),$(".def-result-message").removeClass("error").addClass("success"),$(".def-result-message").show()}})},changeCaptcha:function(){this.options.captcha.fetch({data:{object:"message"},success:function(){}})},drawCaptcha:function(){$("input[name='captcha_key']").val(this.options.captcha.get("key")),$(".captcha img").attr("src",this.options.captcha.get("image"))},render:function(){var self=this;return self.drawCaptcha(),this.options.messages.each(function(message){var message_view=new MessageView({noivos:self.options.noivos,message:message});message_view.render(),message_view.adopted||$(".def-messages").prepend(message_view.$el),self.messages[message.get("id_template_msg_noivos")]=message_view}),load_css("//assets1.icasei.com.br/assets/formhelper.css"),load_js("//assets1.icasei.com.br/assets/formhelper.js",function(){$("#mensagem").formhelper({defaultField:"nome",autoRender:!1,messages:form_helper_messages,onSubmitError:function(){$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show(),$("html,body").animate({scrollTop:0},200)},onSubmit:function(){this.getData();var id_noivo=self.options.noivos.get("id_noivo"),nome=$("#mensagem #nome").val(),email=$("#mensagem #email").val(),message=$("#mensagem #mensagem").val(),captcha=$("#mensagem #captcha").val(),captcha_key=$("#mensagem #captcha_key").val(),message_obj=new TemplateMsgNoivo;return window.loading.jLoading("block",!0),message_obj.save({nome:nome,email:email,message:message,captcha:captcha,captcha_key:captcha_key,id_noivo:id_noivo},{wait:!0,success:function(){window.dataLayer.push({event:"eventEventGeneric",eventCategory:"Mensagens",eventAction:"Intera\xe7\xe3o",eventLabel:"Recebidas"}),window.loading.jLoading("block",!1),self.options.messages.add(message_obj),$("#mensagem").formhelper("setvalue","nome",""),$("#mensagem").formhelper("setvalue","email",""),$("#mensagem").formhelper("setvalue","mensagem",""),$("#mensagem").formhelper("setvalue","captcha","")},error:function(model,xhr){window.loading.jLoading("block",!1);var response=xhr.responseText,response_obj=JSON.parse(response);for(var i in response_obj.errors){var error=response_obj.errors[i];$("#mensagem").formhelper("flagerror",error.key,error.value)}$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show()}}),!1}}),$("#mensagem").formhelper("init")}),this}})}(jQuery);