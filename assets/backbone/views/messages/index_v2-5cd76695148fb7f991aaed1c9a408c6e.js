var MessagesViewV2=null;!function($){MessagesViewV2=BaseBackboneView.extend({events:{"click .ico-refresh":"changeCaptcha","submit form":"sendMessage"},initialize:function(){this.constructor.__super__.initialize.call(this);var self=this;this.adopted=!0,this.options.captcha.on("change",this.drawCaptcha,this),this.options.messages.on("add",this.addMessage,this);var item=$(".template-messages");item.get(0)?(this.messages=[],this.setElement(item),this.options.onload&&this.options.onload.call(self)):(this.adopted=!1,render_template("template_message_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/messages/"+this.options.noivos.get("template_html_version")+"/index",{noivos:this.options.noivos.attributes,messages:this.options.messages.toJSON(),pagina:this.options.pagina.attributes,captcha:this.options.captcha.attributes},function(ret){self.messages=[],self.setElement(ret),self.options.onload&&self.options.onload.call(self)})),function(a){if(""==a)return{};for(var b={},i=0;i<a.length;++i){var p=a[i].split("=",2);1==p.length?b[p[0]]="":b[p[0]]=decodeURIComponent(p[1].replace(/\+/g," "))}return b}(window.location.search.substr(1).split("&")).msg&&$("#nome").focus()},sendMessage:function(){var self=this,id_noivo=this.options.noivos.get("id_noivo"),nome=$(".mensagens #nome").val(),email=$(".mensagens #email").val(),message=$(".mensagens #mensagem").val(),captcha=$(".mensagens #captcha").val(),captcha_key=$(".mensagens #captcha_key").val();this.$el.find(".txt-error").hide(),this.$el.find(".cnt.error").removeClass("error");var Assert=Validator.Assert,validator=new Validator.Validator,constraints={nome:(new Assert).NotBlank(),email:(new Assert).Email(),mensagem:(new Assert).NotBlank(),captcha:(new Assert).NotBlank(),captcha_key:(new Assert).NotBlank(),id_noivo:(new Assert).NotNull()},obj={nome:nome,email:email,mensagem:message,captcha:captcha,captcha_key:captcha_key,id_noivo:id_noivo},validations=validator.validate(obj,constraints);if(1==validations){var message_obj=new TemplateMsgNoivo;window.loading.jLoading("block",!0),message_obj.save(obj,{wait:!0,success:function(){window.dataLayer.push({event:"eventEventGeneric",eventCategory:"Mensagens",eventAction:"Intera\xe7\xe3o",eventLabel:"Recebidas"}),window.loading.jLoading("block",!1),self.options.messages.add(message_obj),$(".mensagens #nome").val(""),$(".mensagens #email").val(""),$(".mensagens #mensagem").val(""),$(".mensagens #captcha").val(""),$("#cnt-mensagem").text("4000"),self.changeCaptcha()},error:function(model,xhr){window.loading.jLoading("block",!1);var response=xhr.responseText,response_obj=JSON.parse(response);for(var i in response_obj.errors){var error=response_obj.errors[i];$("*[data-field='"+error.key+"']").parent(".cnt").addClass("error").find(".txt-error").html(error.value).show()}$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show(),$("html,body").animate({scrollTop:0},200)}})}else{for(validation in validations)$("*[data-field='"+validation+"']").parent(".cnt").addClass("error").find(".txt-error").html(I18n.t("validatorjs."+validations[validation][0].assert.__class__.toLowerCase())).show();$(".def-result-message").addClass("error").removeClass("success"),$(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),$(".def-result-message").show(),$("html,body").animate({scrollTop:0},200)}},addMessage:function(model){var self=this;new MessageViewV2({noivos:this.options.noivos,message:model,onload:function(){this.render(),this.adopted||0!=model.get("aprovada")&&($(".no-message").remove(),$(".msgs > .row > ul").prepend(this.$el),this.$el.addClass("start_vertical_roll_animation")),self.messages[model.get("id_template_msg_noivos")]=this;var msg=I18n.t("messages.message_sent");0==model.get("aprovada")&&(msg+=" "+I18n.t("messages.message_waiting")),$(".def-result-message").html(msg),$(".def-result-message").removeClass("error").addClass("success"),$(".def-result-message").show()}})},changeCaptcha:function(){this.options.captcha.fetch({data:{object:"message"},success:function(){}})},drawCaptcha:function(){$("input[name='captcha_key']").val(this.options.captcha.get("key")),$(".captcha img").attr("src",this.options.captcha.get("image"))},render:function(){$("#mensagem").ready(function(){$("#mensagem").keyup(function(){var len=this.value.length;4e3==len&&(this.value=this.value.substring(0,4e3)),$("#cnt-mensagem").text(4e3-len)})});var self=this;return load_js("//assets1.icasei.com.br/assets/plugins/validator.js",function(){self.drawCaptcha(),self.options.messages.each(function(message){var message_view=new MessageViewV2({noivos:self.options.noivos,message:message});message_view.render(),message_view.adopted||$(".def-messages").prepend(message_view.$el),self.messages[message.get("id_template_msg_noivos")]=message_view})}),this}})}(jQuery);